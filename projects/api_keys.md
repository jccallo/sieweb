# Api Keys

```sql
CREATE TABLE api_keys (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,

    -- Due√±o de la key
    owner_type VARCHAR(50) NOT NULL,
    owner_id BIGINT UNSIGNED NOT NULL,

    -- Informaci√≥n descriptiva
    name VARCHAR(255) NOT NULL,

    -- Seguridad
    key_hash CHAR(64) NOT NULL UNIQUE,

    -- Permisos
    abilities JSON NOT NULL,

    -- Uso y expiraci√≥n
    last_used_at TIMESTAMP NULL,
    expires_at TIMESTAMP NULL,

    -- Estado
    is_active BOOLEAN NOT NULL DEFAULT TRUE,

    -- Control de empresa
    created_by BIGINT UNSIGNED NULL,
    revoked_at TIMESTAMP NULL,
    rate_limit INT NULL,
    allowed_ips JSON NULL,

    -- Timestamps
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,

    -- √çndices recomendados
    INDEX idx_owner (owner_type, owner_id),
    INDEX idx_active (is_active),
    INDEX idx_expires_at (expires_at)
);

request_count INT DEFAULT 0 NOT NULL,  -- contador actual (OPCIONAL)
window_start TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL, -- inicio de ventana (OPCIONAL)
```
Mejorado api_keys
```sql
CREATE TABLE api_keys (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,

    -- Due√±o de la key
    owner_type VARCHAR(50) NOT NULL,
    owner_id BIGINT UNSIGNED NOT NULL,

    -- Informaci√≥n descriptiva
    name VARCHAR(255) NOT NULL,

    -- Seguridad
    key_hash CHAR(64) NOT NULL UNIQUE,

    -- Permisos
    abilities JSON NOT NULL,

    -- Uso y expiraci√≥n
    last_used_at TIMESTAMP NULL,
    expires_at TIMESTAMP NULL,

    -- Estado
    is_active BOOLEAN NOT NULL DEFAULT TRUE,

    -- Control de empresa
    created_by BIGINT UNSIGNED NULL,
    revoked_at TIMESTAMP NULL,

    -- Rate limit
    rate_limit INT NULL,          -- m√°ximo de requests
    window_seconds INT NOT NULL DEFAULT 60, -- duraci√≥n de ventana

    allowed_ips JSON NULL,

    -- Timestamps
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,

    -- √çndices recomendados
    INDEX idx_owner (owner_type, owner_id),
    INDEX idx_active (is_active),
    INDEX idx_expires_at (expires_at)
);

```

api_key_rate_limits
```sql
CREATE TABLE api_key_rate_limits (
    api_key_id BIGINT UNSIGNED PRIMARY KEY,
    request_count INT UNSIGNED NOT NULL DEFAULT 0,
    window_start DATETIME NOT NULL,

    CONSTRAINT fk_rate_limit_api_key
        FOREIGN KEY (api_key_id)
        REFERENCES api_keys(id)
        ON DELETE CASCADE
);
```

Tabla final para Firebird (Rate limit incluido)
```sql
CREATE TABLE api_keys (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    owner_type VARCHAR(50) NOT NULL,
    owner_id BIGINT NOT NULL,
    name VARCHAR(255) NOT NULL,
    key_hash CHAR(64) NOT NULL,
    abilities BLOB SUB_TYPE 1 SEGMENT SIZE 80 NOT NULL,
    last_used_at TIMESTAMP,
    expires_at TIMESTAMP,
    created_by BIGINT,

    deactivated_at TIMESTAMP,
    revoked_at TIMESTAMP,

    rate_limit INT DEFAULT 60 NOT NULL,    -- m√°ximo requests por ventana
    window_seconds INT DEFAULT 60 NOT NULL, 

    allowed_ips BLOB SUB_TYPE 1 SEGMENT SIZE 80,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT uq_key_hash UNIQUE (key_hash)
);

-- √çndices recomendados
CREATE INDEX idx_owner ON api_keys(owner_type, owner_id);
CREATE INDEX idx_key_valid ON api_keys(key_hash, revoked_at, deactivated_at);

```

propuesta de rate limit en memoria
```ts
// rate-limit.service.ts
interface RateLimitData {
  count: number;
  windowEnd: number;
}

const limits = new Map<string, RateLimitData>();

export class RateLimitService {
  static defaultRateLimit = 100;          // Requests por ventana
  static defaultWindowSeconds = 60;       // Duraci√≥n ventana en segundos
  static alertThreshold = 10_000;         // Alerta si supera req/min
  static maxKeys = 50_000;                // M√°ximo de keys en memoria

  /**
   * Check r√°pido en memoria
   */
  static check(apiKey: string, rateLimit = RateLimitService.defaultRateLimit, windowSeconds = RateLimitService.defaultWindowSeconds): boolean {
    const now = Date.now();
    let data = limits.get(apiKey);

    if (!data || now > data.windowEnd) {
      data = { count: 1, windowEnd: now + windowSeconds * 1000 };
      limits.set(apiKey, data);
      RateLimitService.ensureMaxKeys();
      return true;
    }

    if (data.count < rateLimit) {
      data.count += 1;
      RateLimitService.handleAlert(apiKey, data.count);
      return true;
    }

    return false; // L√≠mite superado
  }

  /**
   * Manejo de alertas de tr√°fico extremo
   */
  private static handleAlert(apiKey: string, count: number) {
    if (count > RateLimitService.alertThreshold) {
      console.warn(`ALERTA: API key ${apiKey} super√≥ ${RateLimitService.alertThreshold} req/min en este nodo`);
    }
  }

  /**
   * Limitar el tama√±o del Map para no crecer indefinidamente
   */
  private static ensureMaxKeys() {
    if (limits.size <= RateLimitService.maxKeys) return;

    // Borrar keys m√°s antiguas hasta reducir tama√±o
    const keys = Array.from(limits.keys());
    const removeCount = limits.size - RateLimitService.maxKeys;
    for (let i = 0; i < removeCount; i++) {
      limits.delete(keys[i]);
    }
  }
}
```

Creado por Claude Code (decidir al final los index)

```sql
CREATE TABLE api_keys (
    id             BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    owner_type     VARCHAR(50) NOT NULL,
    owner_id       BIGINT NOT NULL,
    owner_name     VARCHAR(255) NOT NULL,
    name           VARCHAR(255) NOT NULL,
    key_hash       CHAR(64) NOT NULL,
    abilities      BLOB SUB_TYPE 1 SEGMENT SIZE 80 NOT NULL,
    last_used_at   TIMESTAMP,
    expires_at     TIMESTAMP,
    created_by     BIGINT,
    deactivated_at TIMESTAMP,
    revoked_at     TIMESTAMP,
    rate_limit     INT DEFAULT 60 NOT NULL,
    window_seconds INT DEFAULT 60 NOT NULL,
    allowed_ips    BLOB SUB_TYPE 1 SEGMENT SIZE 80,
    created_at     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT uq_key_hash UNIQUE (key_hash)
);

-- B√∫squeda de keys por owner (el m√°s frecuente)
CREATE INDEX idx_api_keys_owner ON api_keys (owner_id, owner_type);

-- Validaci√≥n de la key en cada request (cr√≠tico, debe ser ultrarr√°pido)
CREATE INDEX idx_api_keys_key_hash ON api_keys (key_hash);

-- Consultas de keys activas/inactivas
CREATE INDEX idx_api_keys_deactivated ON api_keys (deactivated_at);
CREATE INDEX idx_api_keys_revoked ON api_keys (revoked_at);

-- Consultas de keys expiradas
CREATE INDEX idx_api_keys_expires ON api_keys (expires_at);

-- Auditor√≠a: qui√©n cre√≥ las keys
CREATE INDEX idx_api_keys_created_by ON api_keys (created_by);
```

# üöÄ Wayra Architecture: H√≠brida Fluent-Bootstrap

Este documento contiene las instrucciones maestras para configurar la IA en futuros proyectos, asegurando que el desarrollo mantenga el mismo nivel de calidad t√©cnica y est√©tica.

---

## üìã Copia y pega este prompt:

> **Contexto del Proyecto: Arquitectura React H√≠brida Fluent-Bootstrap**
> 
> Quiero que el desarrollo de mis componentes siga este est√°ndar t√©cnico espec√≠fico:
> 
> 1. **Stack T√©cnico**: Base estructural con **Radix UI Primitives** (para accesibilidad y l√≥gica) y toda la capa de estilos exclusivamente con **Tailwind CSS**.
> 2. **Est√©tica Visual**: Estilo **Microsoft Fluent UI** (bordes de 6px, paleta neutral, tipograf√≠a institucional).
> 3. **Sistema de Animaci√≥n**: Implementar el movimiento de Microsoft (Efecto **Slide Up + Zoom-In** personalizado con `cubic-bezier(0.1, 0.9, 0.2, 1)` y duraci√≥n de 200ms).
> 4. **Salud Visual**: Sombras "Fluent Soft" (bajos contrastes, muy difusas y ligeras) y overlays con `backdrop-blur-sm` (4px) para evitar fatiga visual.
> 5. **API de Componentes (estilo BootstrapVue)**: Los componentes deben ser declarativos y f√°ciles de usar en React:
>    - `size`: (sm, md, lg, xl, 2xl) para anchos autom√°ticos.
>    - `busy`: Prop para estados de carga/bloqueo.
>    - `okTitle` / `cancelTitle`: Para etiquetas de botones.
>    - `noCloseOnBackdrop`: Para persistencia del componente.
>    - `state`: (true/false/null) Para estados de validaci√≥n (estilo BootstrapVue).
> 6. **Responsabilidad √önica (Atomicity)**: Cada componente, m√©todo o utilidad debe hacer **una sola cosa y bien clara**. Si un componente crece demasiado, debe dividirse en sub-componentes especializados.
> 7. **Arquitectura**: Usar el **Patr√≥n de Componentes Compuestos** (ej. `Modal.Header`, `Modal.Body`, `Modal.Footer`) para permitir control total cuando sea necesario.

---

## üí° Notas Adicionales
- **Accesibilidad**: Al usar Radix, garantizamos soporte para teclado y lectores de pantalla.
- **Rendimiento**: Tailwind asegura que el CSS sea m√≠nimo y optimizado.
- **Experiencia de Desarrollador (DX)**: La API inspirada en BootstrapVue reduce la curva de aprendizaje y acelera el desarrollo.


